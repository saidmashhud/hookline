# HookLine v2.1 Release Notes

## Embedded Mode Admin Lockdown

**New environment variable: `HL_EMBEDDED_MODE`**

When set to `true` (alongside `HL_AUTH_MODE=service_token`), HookLine restricts the service token to data-plane scopes only. This prevents the control-plane (Mashgate) from accidentally accessing admin-only operations.

**Restricted scopes:** `events.publish`, `endpoints.read`, `endpoints.write`, `subscriptions.read`, `subscriptions.write`, `deliveries.read`, `deliveries.retry`, `dlq.read`, `dlq.replay`, `stream.subscribe`

**Blocked operations:**
- `GET/POST /v1/tenants/*` → 403
- `GET/POST /v1/apikeys/*` → 403
- `GET/POST /v1/admin/*` → 403

### Console Blocked in Embedded Mode

The `/console` web UI is no longer publicly accessible when `HL_EMBEDDED_MODE=true`. In standalone mode, `/console` continues to serve the admin interface without authentication.

**Migration:** If you are running HookLine in embedded mode with Mashgate, add `HL_EMBEDDED_MODE=true` to your environment. No code changes are needed — this is a configuration-only change.

## W3C Trace Context Propagation

HookLine now supports end-to-end distributed tracing via [W3C Trace Context](https://www.w3.org/TR/trace-context/) headers.

### How it works

1. **Ingest:** When publishing events via `POST /v1/events`, include `traceparent` and optionally `tracestate` HTTP headers.
2. **Store:** HookLine stores the trace context in a `_trace` metadata field on the event.
3. **Deliver:** When delivering the webhook to an endpoint, HookLine includes the original `traceparent` and `tracestate` headers in the HTTP request.

### Example

```bash
# Publish with trace context
curl -X POST http://localhost:8080/v1/events \
  -H "Authorization: Bearer dev-secret" \
  -H "Content-Type: application/json" \
  -H "traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01" \
  -H "tracestate: congo=t61rcWkgMzE" \
  -d '{"topic":"orders.created","payload":{"order_id":"123"}}'

# The webhook delivery to your endpoint will include:
#   traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01
#   tracestate: congo=t61rcWkgMzE
```

Events published without trace headers are delivered without them — no trace context is fabricated.

### Integration with Mashgate

When mg-events forwards requests to HookLine, it includes `traceparent`/`tracestate` extracted from gRPC metadata. This enables full end-to-end tracing: client → mg-events → HookLine → consumer endpoint.

## New Test Suites

Two new integration test scripts:

- **`test/embedded-mode.sh`** — validates scope restrictions, admin lockdown, and console blocking when `HL_EMBEDDED_MODE=true`
- **`test/trace-propagation.sh`** — verifies W3C trace headers flow from event publish through delivery to the consumer endpoint

### Running

```bash
# Embedded mode tests (requires HookLine with HL_EMBEDDED_MODE=true)
HL_URL=http://localhost:8080 \
HL_SERVICE_TOKEN=super-secret \
./test/embedded-mode.sh

# Trace propagation tests (standalone or embedded mode)
HL_URL=http://localhost:8080 \
HL_API_KEY=dev-secret \
./test/trace-propagation.sh
```

## Full Changelog

- Added `HL_EMBEDDED_MODE` env var for data-plane scope restriction
- Blocked `/console` in embedded mode
- Added W3C Trace Context propagation (`traceparent`, `tracestate`)
- Added `_trace` metadata field to events
- New test suite: `test/embedded-mode.sh`
- New test suite: `test/trace-propagation.sh`
- Updated documentation: `docs/embedded-mode.md`
