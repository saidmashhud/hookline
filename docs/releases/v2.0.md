# GatePulse v2.0 — Enterprise-grade OSS

> **Breaking changes** are present. See [Migration Guide](#migration-guide).

## Highlights

- **Scopes / RBAC**: API keys now carry scopes (`events:write`, `events:read`, `endpoints:manage`, `subscriptions:manage`, `replay:write`, `dlq:manage`, `admin`); operations return 403 when scope is missing
- **Secrets encryption at rest**: Endpoint `secret` fields are encrypted with AES-256-GCM using `GP_MASTER_KEY`; `POST /v1/admin/rotate-secrets` re-encrypts all secrets on key rotation
- **Audit log**: All mutating operations (endpoint/subscription CRUD, replay, DLQ requeue, API key create/revoke) are appended to an immutable audit log; queryable via `GET /v1/admin/audit`
- **Event filters & transformation DSL**: Subscriptions accept a `filter` JSON object (eq/neq/gt/gte/lt/lte/contains/and/or/not on dot-separated paths) and a `transformation` spec (rename/add/remove/set fields); filtering happens at routing time, transformation at delivery time
- **Web console**: Full CRUD UI at `/console/` — dashboard, endpoints, subscriptions, events, deliveries, DLQ, replay, live SSE stream; no build step, vanilla JS
- **Optional Postgres backend**: `GP_STORE_BACKEND=postgres` + `GP_POSTGRES_URL` to use PostgreSQL instead of the C daemon; schema migrations in `priv/sql/`

## Breaking Changes

1. **API keys without scopes** created before v2.0 are treated as having all scopes during a grace period (configure via `GP_LEGACY_KEY_GRACE=true`, default `true`). Set to `false` to enforce strict scopes.
2. **Endpoint `secret` field** is now write-only on `GET /v1/endpoints/:id` (returned as `"***"`).
3. **`POST /v1/subscriptions`** body now accepts `filter` and `transform` optional fields. Existing subscriptions without these fields are unaffected.

## Migration Guide

### Upgrading from v1.x

1. **Set `GP_MASTER_KEY`** (32-byte hex or base64) before starting v2.0 — required when encryption is enabled:
   ```bash
   export GP_MASTER_KEY=$(openssl rand -hex 32)
   ```
2. **Encrypt existing secrets**:
   ```bash
   curl -X POST http://localhost:8080/v1/admin/rotate-secrets \
     -H "Authorization: Bearer $GP_API_KEY"
   ```
3. **Assign scopes to existing API keys** via `PATCH /v1/apikeys/:id` or recreate them with desired scopes.

### Postgres Backend (optional)

```bash
export GP_STORE_BACKEND=postgres
export GP_POSTGRES_URL=postgres://user:pass@host:5432/gatepulse
# Run migrations:
psql $GP_POSTGRES_URL -f priv/sql/001_initial.sql
```

## New API Endpoints

| Method | Path | Scope | Description |
|--------|------|-------|-------------|
| `GET` | `/v1/admin/audit` | `admin` | Paginated audit log |
| `POST` | `/v1/admin/rotate-secrets` | `admin` | Re-encrypt all endpoint secrets |
| `GET` | `/console/` | public | Web management console |

## New Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `GP_MASTER_KEY` | (none) | AES-256-GCM key for secret encryption |
| `GP_STORE_BACKEND` | `c` | `c` or `postgres` |
| `GP_POSTGRES_URL` | (none) | PostgreSQL connection URL |
| `GP_LEGACY_KEY_GRACE` | `true` | Treat pre-v2 keys as full-scope |

## Subscription Filter & Transform Examples

```json
{
  "topic_pattern": "orders.*",
  "filter": {
    "op": "and",
    "conditions": [
      {"op": "gt", "path": "data.amount", "value": 100},
      {"op": "eq", "path": "data.currency", "value": "USD"}
    ]
  },
  "transform": [
    {"op": "rename_field", "from": "data.customer_id", "to": "data.user_id"},
    {"op": "remove_field", "path": "data.internal_notes"},
    {"op": "set_field", "path": "data.source", "value": "gatepulse"}
  ]
}
```

Only events matching the filter are delivered; the payload received by the endpoint reflects all transform operations.
