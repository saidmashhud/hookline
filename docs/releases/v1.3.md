# GatePulse v1.3 — HA / Multi-node

## Highlights

- **Leader election**: Multiple API nodes via Erlang `global` — only the leader runs the delivery poller and worker pool
- **Job lease ownership**: Each claimed job is tagged with `node_id` and a `lease_until` timestamp; orphaned jobs from dead nodes are automatically reaped
- **Helm chart**: `helm/gatepulse/` — deploys API deployment + store StatefulSet with PVC; includes HPA and configmap
- **HA deployment guide**: `docs/production/ha-deployment.md`

## Breaking Changes

None for single-node deployments. Multi-node requires all nodes to be Erlang-distributed (configured via `vm.args`).

## Architecture

```
             ┌─────────────────────────────────────────┐
             │          Erlang cluster (cookie-auth)    │
             │                                          │
  ┌──────────┴──────────┐         ┌────────────────┐   │
  │   API node A        │         │  API node B    │   │
  │   (leader)          │         │  (follower)    │   │
  │   runs delivery     │         │  API only      │   │
  │   poller + workers  │         │                │   │
  └──────────┬──────────┘         └────────┬───────┘   │
             │                             │            │
             └─────────────────────────────┘            │
                         │                              │
                  ┌──────┴──────┐                       │
                  │  gp_store   │                       │
                  │  (C daemon, │                       │
                  │  1 replica) │                       │
                  └─────────────┘                       │
             └─────────────────────────────────────────┘
```

On leader failure, `global` elects a new leader within ~5 seconds; delivery resumes automatically. Jobs with expired leases are reaped and re-delivered (at-least-once guarantee preserved).

## Helm Quickstart

```bash
helm install gatepulse helm/gatepulse/ \
  --set apiKey=your-secret-key \
  --set replicaCount=2
```

## New Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `GP_NODE_NAME` | `gatepulse@hostname` | Erlang node name |
| `GP_COOKIE` | (required for cluster) | Erlang distribution cookie |
| `GP_JOB_LEASE_SECS` | `60` | Job lease duration before reap |

## Upgrade Notes

Single-node deployments require no changes. To enable clustering, set `GP_NODE_NAME` and `GP_COOKIE` consistently across all nodes and ensure Erlang distribution ports (4369 EPMD + dynamic) are open between nodes.
